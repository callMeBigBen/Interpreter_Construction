package Lexer;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.HashMap;
import Parser.*;

public class run {
	
	//ï¿½ï¿½ï¿½å±£ï¿½ï¿½ï¿½ï¿½
	static ArrayList<String> reserved_word = new ArrayList<String>();
	//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	static ArrayList<String> operator = new ArrayList<String>();
	//ï¿½ï¿½ï¿½ï¿½ï¿½Ê¶ï¿½ï¿½ï¿½ï¿½
	static ArrayList<String> identifier = new ArrayList<String>();
	//ï¿½ï¿½ï¿½ï¿½tokenÓ³ï¿½ï¿½ï¿½
	//static HashMap<String,Integer> tokens = new HashMap<String,Integer>();
	static ArrayList<Token> tokens = new ArrayList<Token>();
	//LineNum
	static int lineNum = 0;
	//ï¿½ï¿½ï¿½Öµ
	public static void fill_list(){
		//character:-1
		//number:-2
		//
		reserved_word.add("boolean"); //1 
		reserved_word.add("char");	   //2
		reserved_word.add("int");//3
		reserved_word.add("double");//4
		reserved_word.add("string");//5
		reserved_word.add("true");//6
		reserved_word.add("false");//7
		reserved_word.add("if");//8
		reserved_word.add("else");//9
		reserved_word.add("while");//10
		reserved_word.add("for");//11
		reserved_word.add("break");//12
		reserved_word.add("continue");//13
		reserved_word.add("void");//14
		reserved_word.add("return");//15
		
		operator.add("(");//16
		operator.add(")");//17
		operator.add("{");//18
		operator.add("}");//19
		operator.add("[");//20
		operator.add("]");//21
		operator.add(";");//22
		operator.add(",");//23
		operator.add("=");//24
		operator.add(">");//25
		operator.add("<");//26
		operator.add("==");//27
		operator.add("<=");//28
		operator.add(">=");//29
		operator.add("!=");//30
		operator.add("&&");//31
		operator.add("||");//32
		operator.add("!");//33
		operator.add("+");//34
		operator.add("*");//35
		operator.add("/");//36
		operator.add("%");//37
		operator.add("\"");//38
		operator.add("\'");//39
		//minus"-"40
		//negative "-"41
	}
	
	
	//ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½Îªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½Ò·ï¿½ï¿½Ø¶ï¿½Ó¦ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	public static boolean isReserved(String str){
		for(String rsvdwd:reserved_word){
			if(rsvdwd.equals(str)){
				return true;	//ï¿½Ç±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ò·µ»ï¿½T
			}	
		}
		return false;//ï¿½ï¿½ï¿½Ç±ï¿½ï¿½ï¿½ï¿½Ö£ï¿½ï¿½ï¿½ï¿½ï¿½F
	}
	
	//ï¿½Ð¶ï¿½ï¿½Ç·ï¿½Îªï¿½ï¿½Ä¸
	public static boolean isLetter(char letter){
		if(letter>='a'&&letter<='z' ||letter>='A'&&letter<='Z' )
			return true;
		else
			return false;
	}
	
	//ï¿½Ð¶ï¿½ï¿½Ç·ï¿½Îªï¿½ï¿½ï¿½ï¿½
	public static boolean isNumber(char letter){
		if(letter>='0'&&letter<='9')
			return true;
		else
			return false;
	}
	
	//Ô¤ï¿½ï¿½ï¿½ï¿½
	public static String preProcess(String sourceCode){
		int len = sourceCode.length();
		StringBuffer newCode = new StringBuffer();
		
		for(int i=0;i<len;i++){
			//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½×¢ï¿½ï¿½
			if(sourceCode.charAt(i)=='/'&&sourceCode.charAt(i+1)=='/'){
				i+=2;
				while(sourceCode.charAt(i)!='\n'){
					i++;
				}
				//lineNum++;
			}
			//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½×¢ï¿½ï¿½
			if((sourceCode.charAt(i)=='/'&&sourceCode.charAt(i+1)=='*')){
				i+=2;
				while(!(sourceCode.charAt(i)=='*'&&sourceCode.charAt(i+1)=='/')){
					if(sourceCode.charAt(i)=='\n'){
						lineNum++;
					}
					i++;//ï¿½ï¿½ï¿½ï¿½É¨ï¿½ï¿½
					if (i >= len)
					{
					System.out.println("×¢ï¿½Í³ï¿½ï¿½ï¿½Ã»ï¿½ï¿½ï¿½Òµï¿½ */ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\n");
					System.exit(0);
					}
				}
				i+=2;
			}
			//ï¿½ï¿½ï¿½ï¿½ï¿½Õ¼ï¿½
			if(sourceCode.charAt(i)!='\t' 
			   ){
				newCode.append(sourceCode.charAt(i));
			}
		}
		
		//Ô´ï¿½ï¿½ï¿½ï¿½×ªï¿½ï¿½
		return newCode.toString();	
	}
	
	
	/*
	 * ï¿½Ê·ï¿½ï¿½ï¿½ï¿½àº¯ï¿½ï¿½ï¿½ï¿½ï¿½Ö³ï¿½ï¿½ï¿½ï¿½ï¿½tokenï¿½ï¿½ï¿½Ãµï¿½ï¿½ï¿½Ó¦ï¿½ï¿½ï¿½ï¿½ï¿½Í²ï¿½ï¿½Ò±ï¿½ï¿½ï¿½
	 * ï¿½ï¿½ï¿½Í£ï¿½1.ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½; 2.ï¿½ï¿½Ê¶ï¿½ï¿½; 3.ï¿½ï¿½ï¿½ï¿½;4.ï¿½ï¿½ï¿½ï¿½,5.ï¿½Ö·ï¿½ï¿½ï¿½,6.ï¿½Ö·ï¿½
	 */
	/**
	 * @param sourceCode
	 * @param currPosition
	 * @return
	 */
	public static int scanner(String sourceCode,int currPosition){
		//int tag = -1;
		int movement = 0;//ï¿½ï¿½ï¿½Ú·ï¿½ï¿½Øµï¿½ï¿½Æ¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È¡tokenÖ®ï¿½ï¿½Òªï¿½Ä±ï¿½ï¿½È¡Î»ï¿½Ã£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½Ö¸ï¿½ï¿½
		int len = sourceCode.length();
		StringBuffer token = new StringBuffer();
		char ch = sourceCode.charAt(currPosition);
		
		//ï¿½ï¿½ï¿½Ë¿Õ¸ï¿½
		while(ch==' '){
			currPosition++;
			ch = sourceCode.charAt(currPosition);
			movement++;
		}
		
		//ï¿½ï¿½Ä¸ï¿½ï¿½Í·ï¿½ï¿½ï¿½ï¿½Ê¼ï¿½ï¿½Â¼token
		if(isLetter(ch)&&currPosition<len-1){
			token.append(sourceCode.charAt(currPosition));
			currPosition++;
			//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö»ï¿½ï¿½ï¿½ï¿½ï¿½Ä¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â¼token
			while((isLetter(sourceCode.charAt(currPosition))
					||isNumber(sourceCode.charAt(currPosition)))
					&&currPosition<len-1){
				token.append(sourceCode.charAt(currPosition));
				currPosition++;
			}
			//token.append('\0');
			String tmpstr=token.toString();		
			movement+=tmpstr.length();
			
			//ï¿½é±£ï¿½ï¿½ï¿½Ö±ï¿½,ï¿½Þ¸ï¿½ï¿½Ö·ï¿½ï¿½ï¿½
			Token tokenObj = new Token();
			tokenObj.put(tmpstr,lineNum);
			tokenObj.confirmCode();
			tokens.add(tokenObj);
			
		}
		//ï¿½ï¿½ï¿½Ö¿ï¿½Í·
		else if(isNumber(ch)&&currPosition<len-1){
			token.append(sourceCode.charAt(currPosition));
			currPosition++;
			boolean doted =false;		
			while((currPosition<(len-1)&&isNumber(sourceCode.charAt(currPosition)))
					||sourceCode.charAt(currPosition)=='.'){
				if(isNumber(sourceCode.charAt(currPosition))){
					token.append(sourceCode.charAt(currPosition));
				}
				else if(!doted&&sourceCode.charAt(currPosition)=='.'){
					token.append(sourceCode.charAt(currPosition));
					doted=true;
				}
				else if(doted&&sourceCode.charAt(currPosition)=='.'){
					System.out.println("Line:"+lineNum+" Error, more than one dot. At "+(currPosition+1));
					System.exit(0);
				}
				currPosition++;
			}
			if(isLetter(sourceCode.charAt(currPosition))){
				System.out.println("Error:Line:"+lineNum+" Number can't be followed by a letter!");
				System.exit(0);
			}
			//token.append('\0');

			String tmpstr = token.toString();
			movement+=tmpstr.length();
			
			Token tokenObj = new Token();
			if(tokens.get(tokens.size()-1).code==41){
				tokens.get(tokens.size()-1).put("-"+tmpstr,lineNum);
				tokens.get(tokens.size()-1).confirmCode();
			}
			else{
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}		
		}
		//ï¿½ï¿½ï¿½ï¿½ï¿½Å¿ï¿½Í·
		else if(ch=='+'||ch=='*'||ch=='/'
				||ch=='('||ch==')'||ch=='['||ch==']'||ch=='{'
				||ch=='}'||ch=='%'||ch==','||ch==';'){
			token.append(ch);		
			String tmpstr = token.toString();
			movement++;
			
			Token tokenObj = new Token();
			tokenObj.put(tmpstr,lineNum);
			tokenObj.confirmCode();
			tokens.add(tokenObj);
			
		}
		//ï¿½ï¿½ï¿½ÜµÄ¸ï¿½ï¿½Ï·ï¿½ï¿½Å¿ï¿½Í·
		else if((ch=='!'||ch=='>'||ch=='<'||ch=='&'||ch=='|'||ch=='='||ch=='-')
				&&currPosition<len-1){
			if(ch=='!'&&sourceCode.charAt(currPosition+1)=='='){
				token.append("!=");
				String tmpstr = token.toString();
				movement +=2;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}
			else if(ch=='!'&&sourceCode.charAt(currPosition+1)!='='){
				token.append("!");
				String tmpstr = token.toString();
				movement++;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}
			//Ê¶ï¿½ï¿½-ï¿½ï¿½Îªï¿½ï¿½ï¿½Å£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Òªï¿½ï¿½Ö¹tokensÎªï¿½Õ³ï¿½ï¿½ï¿½(ï¿½ï¿½ÎªÒªï¿½ï¿½ï¿½tokensï¿½ï¿½Ç°Ò»ï¿½ï¿½Ôªï¿½Ø£ï¿½ï¿½ï¿½ï¿½ï¿½Ã»ï¿½ï¿½Ôªï¿½Ø£ï¿½
			else if(ch=='-'&&tokens.isEmpty()){
				System.out.println("Line:"+lineNum+"At"+currPosition+"  Syntax Error: '-' can not be the head of the line!");
<<<<<<< HEAD:Mini/src/Lexer/run.java
				/*token.append(sourceCode.charAt(currPosition));
				currPosition++;
				//ï¿½ï¿½ï¿½Ü·ï¿½Ö¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				//if(currPosition<(len-1)&&!isNumber(sourceCode.charAt(currPosition))){
				//	System.out.println("Line:"+lineNum+"Error,as a nagative sign,'-'can only followed by a number!");
				//	System.exit(0);
				//}
				boolean doted =false;
				while((currPosition<(len-1)&&isNumber(sourceCode.charAt(currPosition)))
						||sourceCode.charAt(currPosition)=='.'){
					if(isNumber(sourceCode.charAt(currPosition))){
						token.append(sourceCode.charAt(currPosition));
					}
					else if(!doted&&sourceCode.charAt(currPosition)=='.'){
						token.append(sourceCode.charAt(currPosition));
						doted=true;
					}
					else if(doted&&sourceCode.charAt(currPosition)=='.'){
						System.out.println("Line:"+lineNum+" Error, more than one dot. At "+(currPosition+1));
						System.exit(0);
					}
					currPosition++;
				}
				String tmpstr = token.toString();
				movement+=tmpstr.length();
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);*/
=======
>>>>>>> f7414af7af9778d1c3ad621f46c8f5c07366cc89:Mini/src/run.java
			}
			//Ê¶ï¿½ï¿½-ï¿½ï¿½Îªï¿½ï¿½ï¿½ï¿½
			else if(ch=='-'&&(tokens.get(tokens.size()-1).code==0)){
				token.append(ch);		
				String tmpstr = token.toString();
				movement++;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}
			//Ê¶ï¿½ï¿½-ï¿½ï¿½Îªï¿½ï¿½ï¿½Å£ï¿½Ç°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Å»ï¿½ï¿½ß±È½Ï¡ï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½
			else if(ch=='-'&&(
					tokens.get(tokens.size()-1).code==16
					||tokens.get(tokens.size()-1).code==24
					||tokens.get(tokens.size()-1).code==25
					||tokens.get(tokens.size()-1).code==26
					||tokens.get(tokens.size()-1).code==27
					||tokens.get(tokens.size()-1).code==28
					||tokens.get(tokens.size()-1).code==29
					||tokens.get(tokens.size()-1).code==30)){
				token.append(sourceCode.charAt(currPosition));
				currPosition++;
				//Ê¶ï¿½ï¿½Îªï¿½ï¿½ï¿½ï¿½Ö®ï¿½ó£¬ºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç±ï¿½Ê¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Å£ï¿½ï¿½ï¿½ï¿½ï¿½
				if((currPosition<len-1)
						&&!isLetter(sourceCode.charAt(currPosition))
						&&!isNumber(sourceCode.charAt(currPosition))){
					System.out.println("Line:"+lineNum+" At "+currPosition+" Syntax Error:Unknown '-'");
					System.exit(0);
				}
				
				String tmpstr = token.toString();
				movement+=tmpstr.length();

				Token tokenObj = new Token();
				tokenObj.put(tmpstr+"_",lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}
			//Ê¶±ðÎ´Öª¸ººÅ
			else if(ch=='-'){
				System.out.println("Line:"+lineNum+" At "+currPosition+" unknown '-'");
				System.exit(0);
			}
			else if(ch=='='&&sourceCode.charAt(currPosition+1)!='='){
				token.append("=");
				String tmpstr = token.toString();
				movement++;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}
			else if(ch=='='&&sourceCode.charAt(currPosition+1)=='='){
				token.append("==");
				String tmpstr = token.toString();
				movement +=2;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}
			else if(ch=='>'&&sourceCode.charAt(currPosition+1)=='='){
				token.append(">=");
				String tmpstr = token.toString();
				movement+=2;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}else if(ch=='>'&&sourceCode.charAt(currPosition+1)!='='){
				token.append(">");
				String tmpstr = token.toString();
				movement++;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}else if(ch=='<'&&sourceCode.charAt(currPosition+1)=='='){
				token.append("<=");
				String tmpstr = token.toString();
				movement+=2;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}else if(ch=='<'&&sourceCode.charAt(currPosition+1)!='='){
				token.append("<");
				String tmpstr = token.toString();
				movement+=2;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}else if(ch=='&'&&sourceCode.charAt(currPosition+1)=='&'){
				token.append("&&");
				String tmpstr = token.toString();
				movement+=2;
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}else if(ch=='|'&&sourceCode.charAt(currPosition+1)=='|'){
				token.append("||");
				String tmpstr = token.toString();
				movement+=tmpstr.length();
				
				Token tokenObj = new Token();
				tokenObj.put(tmpstr,lineNum);
				tokenObj.confirmCode();
				tokens.add(tokenObj);
			}
		}
		//Ë«ï¿½ï¿½ï¿½ï¿½
		else if(ch=='\"'&&currPosition<len-1){
			token.append(sourceCode.charAt(currPosition));
			currPosition++;
		    while(sourceCode.charAt(currPosition)!='\"'){
		    	token.append(sourceCode.charAt(currPosition));
		    	currPosition++;
		    	if(currPosition>=len-1){
		    		System.out.println("Error:Line: "+lineNum+" There is only one '\"'");
		    		System.exit(0);
		    	}
		    }
		    token.append(sourceCode.charAt(currPosition));
		    String tmpstr = token.toString();
		    movement+=tmpstr.length();
		    
		    Token tokenObj = new Token();
			tokenObj.put(tmpstr,lineNum);
			tokenObj.confirmCode();
			tokens.add(tokenObj);		
		}
		//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				else if(ch=='\''&&currPosition<len-1){
					token.append(sourceCode.charAt(currPosition));
					currPosition++;
					int charLength = 1;
				    while(sourceCode.charAt(currPosition)!='\''){
				    	if(charLength>1){
<<<<<<< HEAD:Mini/src/Lexer/run.java
				    		System.out.println("Line:"+lineNum+" ï¿½Ö·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï·¨ï¿½ï¿½ï¿½ï¿½Î»ï¿½Ã£ï¿½"+currPosition+":"+sourceCode.charAt(currPosition));
				    		System.exit(0);
=======
				    		System.out.println("Line:"+lineNum+" ×Ö·û³¬³¤£¬Óï·¨´íÎó£¬Î»ÖÃ£º"+currPosition+":"+sourceCode.charAt(currPosition));
				    		//System.exit(0);
>>>>>>> f7414af7af9778d1c3ad621f46c8f5c07366cc89:Mini/src/run.java
				    	}
				    	token.append(sourceCode.charAt(currPosition));
				    	charLength++;
				    	currPosition++;
				    	if(currPosition>=len-1){
				    		System.out.println("Error:Line: "+lineNum+" There is only one '\''");
				    		System.exit(0);
				    	}
				    }
				    token.append(sourceCode.charAt(currPosition));
				    String tmpstr = token.toString();
				    movement+=tmpstr.length();
				    
				    Token tokenObj = new Token();
					tokenObj.put(tmpstr,lineNum);
					tokenObj.confirmCode();
					tokens.add(tokenObj);			
				}
		else{
			//ï¿½ï¿½ï¿½ï¿½Ê¶ï¿½ï¿½ï¿½Î´Öªï¿½ï¿½ï¿½Å£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			System.out.println("Line:"+lineNum+" Error, unknown character. At "+(currPosition+1));
			System.exit(0);
		}
		
		return movement;
	}
	
	//ï¿½ï¿½È¡ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½
	public static String readToString(String fileName) {  
        String encoding = "UTF-8";  
        File file = new File(fileName);  
        Long filelength = file.length();  
        byte[] filecontent = new byte[filelength.intValue()];  
        try {  
            FileInputStream in = new FileInputStream(file);  
            in.read(filecontent);  
            in.close();  
        } catch (FileNotFoundException e) {  
            e.printStackTrace();  
        } catch (IOException e) {  
            e.printStackTrace();  
        }  
        try {  
            return new String(filecontent, encoding);  
        } catch (UnsupportedEncodingException e) {  
            System.err.println("The OS does not support " + encoding);  
            e.printStackTrace();  
            return null;  
        }  
    }
	

	public static void main(String[] args) {
		fill_list();
		//System.out.println(operator.get(0));
		//ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½
		try {
			//ï¿½ï¿½ï¿½ï¿½ï¿½Ä±ï¿½
			//Ô¤ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½×¢ï¿½ï¿½
			String inputStr = preProcess(readToString("code.txt"));
			File file = new File("code2.txt");
			file.createNewFile();
			FileWriter writer = new FileWriter(file);
			writer.write(inputStr);
			writer.flush();
			writer.close();	
			BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(new File("code2.txt"))));
			
			//É¨ï¿½ï¿½
			String newSrc = reader.readLine();
			lineNum++;
			while(newSrc!=null){
				int i = 0;
				int len = newSrc.length();
				while(i<len){
					i+=scanner(newSrc,i);
				}
				newSrc = reader.readLine();
				lineNum++;
			}
			reader.close();
			
			for(Token tk:tokens){
				System.out.println("line:"+tk.line+",  "+tk.content+",  Code:"+tk.code);
			}
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		
	}

}
